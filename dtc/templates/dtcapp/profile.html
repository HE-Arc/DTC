{% extends 'dtcapp/base.html' %}

{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'dtcapp/profile.css' %}">
{% endblock %}

{% block title %}Profile{% endblock %}

{% block content %}

<div class="d-flex justify-content-center p-5">
    <div class="flex-column">
        <div class="text-center">

            <img class="profile-pic" src="{{ user.pictureURL }}" />

            <div class="text-center text-user h1 m-0 mt-2 font-weight-bold">{{ user.username }}</div>
            <div class="text-center h4 m-0 mb-3">{{ user.email }}</div>

            <a class=" btn btn-lg btn-weight btn-twitch btn-block text-uppercase mb-4" href="{% url 'subscriptions' %}">
                My subscriptions
            </a>
            <a class="btn btn-lg btn-weight btn-twitch-reversed btn-block text-uppercase" role="button"
                data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded=""
                aria-controls="collapseOne">
                My liked clips
            </a>
        </div>
    </div>
</div>


<div class="d-flex justify-content-center">
    <div class="panel-group w-100" id="accordion" role="tablist" aria-multiselectable="true">
        <div id="collapseOne" class="panel-collapse collapse w-100" role="tabpanel" aria-labelledby="headingOne">

            {% if not likedclips %}

            <div class="text-center mt-2 mb-4 text-twitch text-uppercase display-4 font-weight-bold w-100">
                You haven't liked any clips yet !
            </div>

            {% else %}

            <div id="allClips">

                {% for clip in likedclips %}

                <div class="text-center mb-4 bg-twitch-lightest border border-dark w-100">
                    <div class="font-weight-bold text-twitch clip-title py-1">{{clip.title_clip}}</div>
                    <div class="container-clip">
                        <a class="btn responsive-iframe index-2 p-0" onclick="load(this)">
                            <img src="{{clip.thumbnailURL_clip}}" loading="lazy" width="100%" height="100%">
                        </a>
                        <iframe class="responsive-iframe" data-value="{{clip.clipURL}}"
                            allowfullscreen="false"></iframe>
                    </div>

                    <form method="post" action="{% url 'dislike' %}" id="like_form" role="form" class="like_form">
                        {% csrf_token %}
                        <p name="output-message"
                            class="mb-0 p-2 font-weight-bold text-uppercase text-twitch-feint bg-success"
                            style="display:none;"></p>
                        <input type="hidden" name="id_clip" id="id_clip" value="{{ clip.id_clip }}">
                        <input type="hidden" name="clipURL" id="clipURL" value="{{ clip.clipURL }}">
                        <input type="hidden" name="title_clip" id="title_clip" value="{{ clip.title_clip }}">
                        <input type="hidden" name="thumbnailURL_clip" id="thumbnailURL_clip"
                            value="{{ clip.thumbnailURL_clip }}">
                        <input type="submit" value="&#xf164" name="btn_like"
                            class="btn btn-lg btn-weight text-uppercase my-1 p-2 lh-0 far fa-thumbs-up btn-twitch">
                    </form>

                </div>

                {% endfor %}
                {% endif %}
            </div>

        </div>
    </div>
</div>

<script>
    var like_forms = document.getElementsByClassName('like_form');

    for (let like_form of like_forms) {
        like_form.addEventListener("submit", function (e) {
            e.preventDefault();

            id_clip = like_form.querySelector('input[name="id_clip"]').value;
            clipURL = like_form.querySelector('input[name="clipURL"]').value;
            title_clip = like_form.querySelector('input[name="title_clip"]').value;
            thumbnailURL_clip = like_form.querySelector('input[name="thumbnailURL_clip"]').value;

            const formData = new FormData();

            formData.append('id_clip', id_clip);
            formData.append('clipURL', clipURL);
            formData.append('title_clip', title_clip);
            formData.append('thumbnailURL_clip', thumbnailURL_clip);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            output_message = like_form.querySelector('p[name="output-message"]');
            btn_like = like_form.querySelector('input[name="btn_like"]');

            chosen_action = like_form.action;

            fetch(chosen_action, {
                method: like_form.method,
                body: formData
            })
                .then(response => response.json())
                .then(data => {

                    if (data.action === 'like') {
                        output_message.innerText = "The clip has been added to your liked list !"
                        btn_like.classList.remove("btn-twitch-reversed");
                        btn_like.classList.add("btn-twitch");
                        like_form.action = "{% url 'dislike' %}";
                        setTimeout(function () {
                            output_message.style.display = "none";
                        }, 3000);
                        setTimeout(function () {
                            output_message.style.display = "";
                        }, 500);
                    }
                    else if (data.action === 'dislike') {
                        output_message.innerText = "The clip has been removed from your liked list !"
                        btn_like.classList.remove("btn-twitch");
                        btn_like.classList.add("btn-twitch-reversed");
                        like_form.action = "{% url 'like' %}";
                        setTimeout(function () {
                            output_message.style.display = "none";
                        }, 3000);
                        setTimeout(function () {
                            output_message.style.display = "";
                        }, 500);
                    }
                })
                .catch(error => {
                    output_message.innerText = "There has been a problem ! Retry again later."
                    setTimeout(function () {
                        output_message.style.display = "none";
                        output_message.classList.remove("bg-danger");
                    }, 3000);
                    setTimeout(function () {
                        output_message.style.display = "";
                        output_message.classList.add("bg-danger");
                    }, 500);
                });
        });
    }
</script>

{% endblock content %}