{% extends 'dtcapp/base.html' %}

{% block title %}Home{% endblock %}

{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'dtcapp/home.css' %}">
{% endblock %}

{% block scripts %}
<script src="{% static 'dtcapp/home.js' %}"></script>
{% endblock %}

{% block content %}

<div id="following" class="bg-twitch">
    {% for streamer in follows %}
    <form method="post" action="{% url 'switch-following' %}">
        {% csrf_token %}
        <input type="hidden" name="following_id" value="{{ streamer.following_id }}">
        <div class="streamer" onClick="javascript:this.parentNode.submit();">
            <img src="{{streamer.image}}" class="{{ streamer.activated|yesno:" activated,unactivated" }}">
            <p>{{streamer.name}}</p>
        </div>
    </form>
    {% endfor %}
</div>

<div id="clips">
    <h1 class="d-inline">My Feed</h1>

    <div class="btn-group dropleft float-right">
        <button class="btn btn-secondary btn-sm dropdown-toggle" type="button" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            Top&nbsp;<span class="top-twitch">{{top}}</span>
        </button>
        <div class="dropdown-menu">
            <a class="dropdown-item" href="{% url 'home-top' top='24H' %}">Top <span class="top-twitch">24H</span></a>
            <a class="dropdown-item" href="{% url 'home-top' top='7D' %}">Top <span class="top-twitch">7D</span></a>
            <a class="dropdown-item" href="{% url 'home-top' top='ALL' %}">Top <span class="top-twitch">ALL</span></a>
        </div>
    </div>

    <div id="allClips">
        {% for clip in clips %}
        <div class="text-center mb-4 bg-twitch-feint">
            <div class="font-weight-bold text-twitch clip-title py-1">{{clip.title}}</div>
            <div class="container-clip">
                <a class="btn responsive-iframe index-2 p-0" onclick="load(this)">
                    <img src="{{clip.thumbnail_url}}" loading="lazy" width="100%" height="100%">
                </a>
                <iframe class="responsive-iframe" data-value="{{clip.embed_url}}" allowfullscreen="false"></iframe>
            </div>

            <form method="post" action="{% url 'like' %}" id="like_form" role="form" class="like_form">
                {% csrf_token %}
                <p name="output-message"></p>
                <input type="hidden" name="id_clip" id="id_clip" value="{{ clip.id }}">
                <input type="hidden" name="clipURL" id="clipURL" value="{{ clip.embed_url }}">
                <input class="btn btn-lg btn-weight btn-twitch-reversed text-uppercase my-1 p-2 lh-0" type="submit">
                <i class="far fa-thumbs-up"></i>
                </input>
            </form>

        </div>
        {% endfor %}
    </div>

</div>

<script>
    var like_forms = document.getElementsByClassName('like_form');

    for (let like_form of like_forms) {
        like_form.addEventListener("submit", function (e) {
            e.preventDefault();

            id_clip = like_form.querySelector('input[name="id_clip"]').value;
            clipURL = like_form.querySelector('input[name="clipURL"]').value;

            const formData = new FormData();

            formData.append('id_clip', id_clip);
            formData.append('clipURL', clipURL);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            output_message = like_form.querySelector('p[name="output-message"]');

            fetch("{% url 'like' %}", {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data);
                    output_message.innerText = "Your enquiry has been sent!"
                    setTimeout(function () {
                        output_message.style.display = "none";
                    }, 3000);
                    setTimeout(function () {
                        output_message.style.display = "";
                    }, 1000);
                })
                .catch(error => {
                    console.error('Error:', error);
                    output_message.innerText = "Sorry! There was an error submitting your enquiry. "
                    setTimeout(function () {
                        output_message.style.display = "none";
                    }, 3000);
                    setTimeout(function () {
                        output_message.style.display = "";
                    }, 1000);
                });
        });
    }
</script>

{% endblock %}